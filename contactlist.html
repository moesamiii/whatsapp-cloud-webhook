<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ - Smile Clinic</title>
    <link rel="icon" type="image/png" href="./img/dummy-conan.jpeg" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="./dashboard.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS for Excel file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      @media (min-width: 1024px) {
        .dashboard-grid {
          width: 100%;
          display: flex;
          justify-content: center;
        }
        .table-card {
          width: 100% !important;
          max-width: none !important;
          margin: 0;
        }
      }

      input,
      button,
      select {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }

      body.dark input,
      body.dark select {
        background: #333;
        color: #fff;
        border-color: #555;
      }

      .add-contact-form {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
      }

      .add-contact-form input,
      .add-contact-form select {
        flex: 1 1 200px;
      }

      .add-contact-form button {
        background: #7c3aed;
        color: white;
        border: none;
        cursor: pointer;
        padding: 8px 16px;
      }

      .success-msg {
        color: green;
        margin-top: 10px;
        display: none;
      }

      .error-msg {
        color: red;
        margin-top: 10px;
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
      }

      th {
        background: #f4f4f4;
      }

      body.dark th {
        background: #222;
      }

      /* ========== EXPORT SECTION STYLES ========== */
      .export-section {
        background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
        border: 2px solid #d946ef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 15px;
      }

      body.dark .export-section {
        background: linear-gradient(135deg, #4a1d6a 0%, #581c87 100%);
        border-color: #e879f9;
      }

      .export-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .export-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #d946ef 0%, #a855f7 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
      }

      .export-text h4 {
        margin: 0 0 4px 0;
        font-size: 16px;
        color: #7e22ce;
      }

      body.dark .export-text h4 {
        color: #e879f9;
      }

      .export-text p {
        margin: 0;
        font-size: 13px;
        color: #6b7280;
      }

      body.dark .export-text p {
        color: #d1d5db;
      }

      .export-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 28px;
        background: linear-gradient(135deg, #d946ef 0%, #a855f7 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(217, 70, 239, 0.3);
      }

      .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(217, 70, 239, 0.4);
        background: linear-gradient(135deg, #e879f9 0%, #c084fc 100%);
      }

      .export-btn:active {
        transform: translateY(0);
      }

      .export-btn i {
        font-size: 18px;
      }

      .contact-count-badge {
        background: rgba(217, 70, 239, 0.15);
        color: #a855f7;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
      }

      body.dark .contact-count-badge {
        background: rgba(217, 70, 239, 0.3);
        color: #e879f9;
      }

      /* ========== IMPORT SECTION STYLES ========== */
      .import-section {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px dashed #7c3aed;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
        transition: all 0.3s ease;
      }

      body.dark .import-section {
        background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
        border-color: #a78bfa;
      }

      .import-section:hover {
        border-color: #5b21b6;
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      }

      body.dark .import-section:hover {
        background: linear-gradient(135deg, #312e81 0%, #4c1d95 100%);
        border-color: #c4b5fd;
      }

      .import-section.dragover {
        border-color: #22c55e;
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        transform: scale(1.02);
      }

      body.dark .import-section.dragover {
        background: linear-gradient(135deg, #14532d 0%, #166534 100%);
      }

      .import-title {
        font-size: 18px;
        font-weight: 600;
        color: #5b21b6;
        margin-bottom: 10px;
      }

      body.dark .import-title {
        color: #c4b5fd;
      }

      .import-description {
        color: #6b7280;
        margin-bottom: 15px;
        font-size: 14px;
      }

      body.dark .import-description {
        color: #9ca3af;
      }

      .import-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .import-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
      }

      .import-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      }

      .import-btn:active {
        transform: translateY(0);
      }

      .import-btn.loading {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .import-btn.loading i {
        animation: spin 1s linear infinite;
      }

      .download-template-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      }

      .download-template-btn:hover {
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .file-input {
        display: none;
      }

      .import-stats {
        margin-top: 15px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        display: none;
      }

      body.dark .import-stats {
        background: rgba(0, 0, 0, 0.3);
      }

      .import-stats.show {
        display: block;
      }

      .import-stats p {
        margin: 5px 0;
        font-size: 14px;
      }

      .import-stats .success {
        color: #16a34a;
      }

      .import-stats .error {
        color: #dc2626;
      }

      .import-stats .info {
        color: #2563eb;
      }

      .import-stats .fixed {
        color: #f59e0b;
      }

      body.dark .import-stats .success {
        color: #4ade80;
      }

      body.dark .import-stats .error {
        color: #f87171;
      }

      body.dark .import-stats .info {
        color: #60a5fa;
      }

      body.dark .import-stats .fixed {
        color: #fbbf24;
      }

      /* Toast notification */
      .toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: #22c55e;
        color: white;
        padding: 16px 32px;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 9999;
      }

      .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      .toast.error {
        background: #ef4444;
      }

      .toast.warning {
        background: #f59e0b;
      }

      /* ========== NEW: GROUPS SECTION STYLES ========== */
      .groups-section {
        background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
        border: 2px solid #fb923c;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }

      body.dark .groups-section {
        background: linear-gradient(135deg, #431407 0%, #7c2d12 100%);
        border-color: #fb923c;
      }

      .groups-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .groups-title {
        font-size: 18px;
        font-weight: 600;
        color: #c2410c;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      body.dark .groups-title {
        color: #fdba74;
      }

      .create-group-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(251, 146, 60, 0.3);
      }

      .create-group-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(251, 146, 60, 0.4);
      }

      .groups-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .group-item {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: white;
        border: 2px solid #fed7aa;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      body.dark .group-item {
        background: #292524;
        border-color: #78350f;
      }

      .group-item:hover {
        border-color: #fb923c;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(251, 146, 60, 0.2);
      }

      .group-item.active {
        background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
        color: white;
        border-color: #fb923c;
      }

      .group-item .group-count {
        background: rgba(251, 146, 60, 0.2);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 600;
      }

      .group-item.active .group-count {
        background: rgba(255, 255, 255, 0.3);
      }

      .group-item .delete-group {
        color: #dc2626;
        cursor: pointer;
        margin-left: 4px;
        font-size: 14px;
      }

      .group-item.active .delete-group {
        color: white;
      }

      .group-item .delete-group:hover {
        color: #991b1b;
      }

      .group-item.active .delete-group:hover {
        color: #fecaca;
      }

      /* Modal for creating groups */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      body.dark .modal-content {
        background: #1f2937;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-header h3 {
        margin: 0;
        color: #fb923c;
        font-size: 20px;
      }

      body.dark .modal-header h3 {
        color: #fdba74;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 30px;
        height: 30px;
      }

      body.dark .modal-close {
        color: #9ca3af;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-body label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
      }

      body.dark .modal-body label {
        color: #d1d5db;
      }

      .modal-body input,
      .modal-body select {
        width: 100%;
        margin-bottom: 15px;
      }

      .filter-options {
        display: grid;
        gap: 10px;
        margin-top: 15px;
      }

      .filter-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .filter-row select,
      .filter-row input {
        flex: 1;
        margin-bottom: 0;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .modal-btn {
        padding: 10px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .modal-btn.cancel {
        background: #e5e7eb;
        color: #374151;
      }

      body.dark .modal-btn.cancel {
        background: #374151;
        color: #d1d5db;
      }

      .modal-btn.save {
        background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
        color: white;
      }

      .modal-btn:hover {
        transform: translateY(-2px);
      }

      /* Service badge */
      .service-badge {
        display: inline-block;
        padding: 4px 10px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      /* Filter controls */
      .filter-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: center;
      }

      .filter-controls select {
        flex: 1 1 200px;
      }

      .clear-filter-btn {
        padding: 8px 16px;
        background: #6b7280;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }

      .clear-filter-btn:hover {
        background: #4b5563;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <div class="logo">
          <span>CONAN DASHBOARD</span>
        </div>
        <nav class="menu">
          <a href="dashboard.html">
            <i class="fa-solid fa-gauge"></i>
            Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
          </a>
          <a href="notifications.html" id="notificationLink">
            <i class="fa-solid fa-bell"></i>
            Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
          </a>
          <a href="analytics.html">
            <i class="fa-solid fa-rocket"></i>
            ØªØ­Ù„ÙŠÙ„Ø§Øª
          </a>
          <a href="booking.html">
            <i class="fa-solid fa-table"></i>
            Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØ§ØµÙ„
          </a>
          <a href="contactlist.html" class="active">
            <i class="fa-solid fa-address-book"></i>
            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØ§ØµÙ„
          </a>
          <a href="AIsettings.html">
            <i class="fa-solid fa-robot"></i>
            Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
          </a>
          <a href="offers.html">
            <i class="fa-solid fa-gift"></i>
            Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø§Ø¹Ù„Ø§Ù†ÙŠØ©
          </a>
        </nav>
      </aside>

      <!-- MAIN -->
      <main class="main-content" id="dashboardContent">
        <header class="header">
          <div class="header-left">
            <button class="menu-toggle icon-btn" id="menuToggle">
              <i class="fa-solid fa-bars"></i>
            </button>
            <h1>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</h1>
          </div>
          <div class="header-right">
            <button class="icon-btn" id="themeToggle">
              <i class="fa-regular fa-moon"></i>
            </button>
          </div>
        </header>

        <section class="dashboard-grid">
          <div class="table-card">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</h3>

            <!-- âœ… NEW: GROUPS SECTION -->
            <div class="groups-section">
              <div class="groups-header">
                <div class="groups-title">
                  <i class="fa-solid fa-layer-group"></i>
                  Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
                </div>
                <button class="create-group-btn" onclick="openGroupModal()">
                  <i class="fa-solid fa-plus"></i>
                  Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </button>
              </div>
              <div class="groups-list" id="groupsList">
                <div class="group-item active" onclick="selectGroup(null)">
                  <i class="fa-solid fa-users"></i>
                  <span>Ø§Ù„ÙƒÙ„</span>
                  <span class="group-count" id="allContactsCount">0</span>
                </div>
              </div>
            </div>

            <!-- âœ… EXPORT TO EXCEL SECTION -->
            <div class="export-section">
              <div class="export-info">
                <div class="export-icon">
                  <i class="fa-solid fa-file-excel"></i>
                </div>
                <div class="export-text">
                  <h4>ØªØµØ¯ÙŠØ± Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h4>
                  <p>Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ…Ù„Ù Excel</p>
                </div>
                <span class="contact-count-badge" id="contactCountBadge"
                  >0 Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„</span
                >
              </div>
              <button class="export-btn" onclick="exportToExcel()">
                <i class="fa-solid fa-download"></i>
                ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
              </button>
            </div>

            <!-- âœ… IMPORT FROM EXCEL SECTION (UPDATED) -->
            <div class="import-section" id="importSection">
              <div class="import-title">
                <i class="fa-solid fa-file-excel"></i>
                Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Excel
              </div>
              <div class="import-description">
                Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯<br />
                <small
                  >ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰: Ø§Ù„Ø§Ø³Ù… (name)ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (phone)ØŒ
                  ÙˆØ§Ù„Ø®Ø¯Ù…Ø© (service) Ø§Ø®ØªÙŠØ§Ø±ÙŠ</small
                ><br />
                <small style="color: #f59e0b"
                  >âœ¨ ÙŠØªÙ… ØªØµØ­ÙŠØ­ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ù†Ù‡Ø§ÙŠØ©
                  Ø§Ù„Ø±Ù‚Ù…</small
                >
              </div>
              <div class="import-buttons">
                <button
                  class="import-btn"
                  id="importBtn"
                  onclick="document.getElementById('excelFileInput').click()"
                >
                  <i class="fa-solid fa-file-import"></i>
                  Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel
                </button>
                <button
                  class="import-btn download-template-btn"
                  id="downloadTemplateBtn"
                  onclick="downloadTemplate()"
                >
                  <i class="fa-solid fa-download"></i>
                  ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Excel
                </button>
              </div>
              <input
                type="file"
                id="excelFileInput"
                class="file-input"
                accept=".xlsx,.xls,.csv"
                onchange="handleFileSelect(event)"
              />
              <div class="import-stats" id="importStats">
                <p class="info" id="totalRows">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ: 0</p>
                <p class="success" id="successRows">ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­: 0</p>
                <p class="fixed" id="fixedRows">ØªÙ… ØªØµØ­ÙŠØ­ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©: 0</p>
                <p class="error" id="errorRows">ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: 0</p>
                <p class="info" id="duplicateRows">Ù…ÙƒØ±Ø±Ø© (ØªÙ… ØªØ®Ø·ÙŠÙ‡Ø§): 0</p>
              </div>
            </div>

            <!-- âœ… Add new contact form (UPDATED with service) -->
            <div class="add-contact-form">
              <input type="text" id="contactName" placeholder="Ø§Ù„Ø§Ø³Ù…" />
              <input type="text" id="contactPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
              <input type="text" id="contactService" placeholder="Ø§Ù„Ø®Ø¯Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
              <button id="addContactBtn">
                <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„
              </button>
            </div>
            <p class="success-msg" id="successMsg">
              âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­
            </p>
            <p class="error-msg" id="errorMsg">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©</p>

            <!-- âœ… Filter controls -->
            <div class="filter-controls">
              <select id="serviceFilter" onchange="applyFilters()">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</option>
              </select>
              <button class="clear-filter-btn" onclick="clearFilters()">
                <i class="fa-solid fa-filter-circle-xmark"></i>
                Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
              </button>
            </div>

            <table id="contactTable">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                  <th>Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <footer>Â© 2025 Smile Clinic</footer>
      </main>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- âœ… NEW: Group Creation Modal -->
    <div class="modal" id="groupModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fa-solid fa-layer-group"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
          <button class="modal-close" onclick="closeGroupModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
          <input type="text" id="groupName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù…Ù„Ø§Ø¡ ØªØ¨ÙŠÙŠØ¶ Ø§Ù„Ø£Ø³Ù†Ø§Ù†" />

          <label>ÙÙ„ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø©</label>
          <select id="groupServiceFilter">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</option>
          </select>

          <label>ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <div class="filter-row">
            <input type="date" id="groupDateFrom" placeholder="Ù…Ù† ØªØ§Ø±ÙŠØ®" />
            <input type="date" id="groupDateTo" placeholder="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn cancel" onclick="closeGroupModal()">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="modal-btn save" onclick="saveGroup()">
            <i class="fa-solid fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
          </button>
        </div>
      </div>
    </div>

    <script>
      // âœ… Supabase setup
      const SUPABASE_URL = "https://ylsbmxedhycjqaorjkvm.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlsc2JteGVkaHljanFhb3Jqa3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTk5NTUsImV4cCI6MjA3NjM5NTk1NX0.W61xOww2neu6RA4yCJUob66p4OfYcgLSVw3m3yttz1E";
      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY
      );

      let contacts = [];
      let allContacts = []; // Store all contacts for filtering
      let existingPhones = new Set();
      let currentGroup = null;
      let groups = [];
      let services = new Set(); // Track available services

      // ========== âœ¨ PHONE NUMBER COUNTRY CODE FIX FUNCTION ========== //
      function fixPhoneCountryCode(phone) {
        let cleaned = String(phone).replace(/\D/g, "");
        if (String(phone).trim().startsWith("+")) {
          return { phone: String(phone).trim(), fixed: false };
        }

        const countryCodes = [
          "966", "962", "971", "973", "974", "968", "965", "961", "963", "964",
          "212", "216", "213", "20",
        ];

        for (const code of countryCodes) {
          if (cleaned.endsWith(code)) {
            const localNumber = cleaned.slice(0, -code.length);
            if (localNumber.length >= 7 && localNumber.length <= 10) {
              const fixedPhone = "+" + code + localNumber;
              console.log(`ğŸ“± Fixed phone: ${phone} -> ${fixedPhone}`);
              return { phone: fixedPhone, fixed: true };
            }
          }
        }

        for (const code of countryCodes) {
          if (cleaned.startsWith(code)) {
            return { phone: "+" + cleaned, fixed: false };
          }
        }

        return { phone: cleaned, fixed: false };
      }

      // Show toast notification
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "toast show";
        if (type === "error") toast.classList.add("error");
        if (type === "warning") toast.classList.add("warning");
        setTimeout(() => {
          toast.className = "toast";
        }, 3000);
      }

      // Update contact count badge
      function updateContactCountBadge() {
        const badge = document.getElementById("contactCountBadge");
        badge.textContent = `${contacts.length} Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„`;
        document.getElementById("allContactsCount").textContent = allContacts.length;
      }

      // Update service filter dropdown
      function updateServiceFilters() {
        const serviceFilter = document.getElementById("serviceFilter");
        const groupServiceFilter = document.getElementById("groupServiceFilter");
        
        // Clear existing options (except "all")
        serviceFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</option>';
        groupServiceFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</option>';
        
        // Add service options
        services.forEach(service => {
          if (service) {
            serviceFilter.innerHTML += `<option value="${service}">${service}</option>`;
            groupServiceFilter.innerHTML += `<option value="${service}">${service}</option>`;
          }
        });
      }

      // âœ… Load contacts (from bookings + contact_list)
      async function loadContacts() {
        const { data: bookingData, error: bookingError } = await supabaseClient
          .from("bookings")
          .select("name, phone, service");

        const { data: contactData, error: contactError } = await supabaseClient
          .from("contact_list")
          .select("*")
          .order("created_at", { ascending: false });

        if (bookingError || contactError) {
          console.error("Error loading data:", bookingError || contactError);
          return;
        }

        // Merge bookings + saved contacts, filter duplicates
        const combined = [...(bookingData || []), ...(contactData || [])];
        const unique = [];
        existingPhones = new Set();
        services.clear();

        combined.forEach((c) => {
          if (!c.phone || existingPhones.has(c.phone)) return;
          existingPhones.add(c.phone);
          
          // Track services
          if (c.service) {
            services.add(c.service);
          }
          
          unique.push({
            name: c.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…",
            phone: c.phone,
            service: c.service || "",
            created_at: c.created_at || new Date().toISOString(),
          });
        });

        allContacts = unique;
        contacts = unique;
        
        updateServiceFilters();
        loadGroups();
        applyCurrentGroupFilter();
        renderContacts();
        updateContactCountBadge();
      }

      // âœ… Add new contact (UPDATED with service)
      async function addContact() {
        const name = document.getElementById("contactName").value.trim();
        let phone = document.getElementById("contactPhone").value.trim();
        const service = document.getElementById("contactService").value.trim();
        const successMsg = document.getElementById("successMsg");
        const errorMsg = document.getElementById("errorMsg");

        successMsg.style.display = "none";
        errorMsg.style.display = "none";

        if (!name || !phone) {
          errorMsg.textContent = "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ";
          errorMsg.style.display = "block";
          return;
        }

        const fixResult = fixPhoneCountryCode(phone);
        phone = fixResult.phone;

        const contactData = { name, phone };
        if (service) {
          contactData.service = service;
        }

        const { error } = await supabaseClient
          .from("contact_list")
          .insert([contactData]);

        if (error) {
          console.error("Error inserting contact:", error);
          errorMsg.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©";
          errorMsg.style.display = "block";
        } else {
          if (fixResult.fixed) {
            successMsg.textContent =
              "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ (ØªÙ… ØªØµØ­ÙŠØ­ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©)";
          } else {
            successMsg.textContent = "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­";
          }
          successMsg.style.display = "block";
          document.getElementById("contactName").value = "";
          document.getElementById("contactPhone").value = "";
          document.getElementById("contactService").value = "";
          loadContacts();
          setTimeout(() => (successMsg.style.display = "none"), 2000);
        }
      }

      // âœ… Render table (UPDATED with service column)
      function renderContacts() {
        const tbody = document.querySelector("#contactTable tbody");
        tbody.innerHTML = "";

        if (!contacts.length) {
          tbody.innerHTML = "<tr><td colspan='4'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
          return;
        }

        contacts.forEach((c) => {
          const row = document.createElement("tr");
          const serviceHtml = c.service 
            ? `<span class="service-badge">${c.service}</span>` 
            : '<span style="color: #9ca3af;">-</span>';
          
          row.innerHTML = `
            <td>${c.name}</td>
            <td dir="ltr" style="text-align: center;">${c.phone}</td>
            <td>${serviceHtml}</td>
            <td>${new Date(c.created_at).toLocaleString("ar-EG")}</td>
          `;
          tbody.appendChild(row);
        });
      }

      // ========== EXPORT TO EXCEL FUNCTION (UPDATED) ==========
      function exportToExcel() {
        if (contacts.length === 0) {
          showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ù„Ù„ØªØµØ¯ÙŠØ±", "warning");
          return;
        }

        try {
          const exportData = contacts.map((contact, index) => ({
            "#": index + 1,
            Ø§Ù„Ø§Ø³Ù…: contact.name,
            "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ": contact.phone,
            Ø§Ù„Ø®Ø¯Ù…Ø©: contact.service || "-",
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©": new Date(contact.created_at).toLocaleString("ar-EG"),
          }));

          const worksheet = XLSX.utils.json_to_sheet(exportData);
          worksheet["!cols"] = [
            { wch: 5 },
            { wch: 25 },
            { wch: 18 },
            { wch: 20 },
            { wch: 22 },
          ];

          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„");

          const today = new Date();
          const dateStr = today.toISOString().split("T")[0];
          const filename = `contacts_export_${dateStr}.xlsx`;

          XLSX.writeFile(workbook, filename);
          showToast(`ØªÙ… ØªØµØ¯ÙŠØ± ${contacts.length} Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!`);
        } catch (error) {
          console.error("Error exporting to Excel:", error);
          showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±", "error");
        }
      }

      // ========== EXCEL IMPORT FUNCTIONS (UPDATED) ==========
      function downloadTemplate() {
        const templateData = [
          { name: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ 1", phone: "+966501234567", service: "ØªØ¨ÙŠÙŠØ¶ Ø§Ù„Ø£Ø³Ù†Ø§Ù†" },
          { name: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ 2", phone: "+962791234567", service: "ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø£Ø³Ù†Ø§Ù†" },
          { name: "Customer Name 3", phone: "+971501234567", service: "Ø­Ø´Ùˆ Ø§Ù„Ø£Ø³Ù†Ø§Ù†" },
        ];

        const worksheet = XLSX.utils.json_to_sheet(templateData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Contacts");
        worksheet["!cols"] = [{ wch: 25 }, { wch: 15 }, { wch: 20 }];

        XLSX.writeFile(workbook, "contacts_template.xlsx");
        showToast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Excel Ø¨Ù†Ø¬Ø§Ø­!");
      }

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const validExtensions = [".xlsx", ".xls", ".csv"];
        const fileExtension = "." + file.name.split(".").pop().toLowerCase();

        if (!validExtensions.includes(fileExtension)) {
          showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel ØµØ§Ù„Ø­ (.xlsx, .xls, .csv)", "error");
          return;
        }

        processExcelFile(file);
      }

      async function processExcelFile(file) {
        const importBtn = document.getElementById("importBtn");
        const importStats = document.getElementById("importStats");

        importBtn.classList.add("loading");
        importBtn.innerHTML =
          '<i class="fa-solid fa-spinner"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...';

        try {
          const data = await readExcelFile(file);

          if (!data || data.length === 0) {
            showToast("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©", "error");
            return;
          }

          const result = await importContacts(data);

          document.getElementById("totalRows").textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ: ${result.total}`;
          document.getElementById("successRows").textContent = `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­: ${result.success}`;
          document.getElementById("fixedRows").textContent = `ØªÙ… ØªØµØ­ÙŠØ­ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©: ${result.fixed}`;
          document.getElementById("errorRows").textContent = `ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ${result.failed}`;
          document.getElementById("duplicateRows").textContent = `Ù…ÙƒØ±Ø±Ø© (ØªÙ… ØªØ®Ø·ÙŠÙ‡Ø§): ${result.duplicates}`;
          importStats.classList.add("show");

          if (result.success > 0) {
            let message = `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${result.success} Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!`;
            if (result.fixed > 0) {
              message += ` (ØªÙ… ØªØµØ­ÙŠØ­ ${result.fixed} Ø±Ù‚Ù…)`;
            }
            showToast(message);
            loadContacts();
          } else if (result.duplicates === result.total) {
            showToast("Ø¬Ù…ÙŠØ¹ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹", "warning");
          } else {
            showToast("Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„", "error");
          }
        } catch (error) {
          console.error("Error processing file:", error);
          showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù", "error");
        } finally {
          importBtn.classList.remove("loading");
          importBtn.innerHTML =
            '<i class="fa-solid fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel';
          document.getElementById("excelFileInput").value = "";
        }
      }

      // Read Excel file (UPDATED to include service)
      function readExcelFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

              const contacts = [];
              const headers = jsonData[0] || [];

              let nameIndex = -1;
              let phoneIndex = -1;
              let serviceIndex = -1;

              const firstRowIsHeader = headers.some((h) => {
                const headerLower = String(h).toLowerCase();
                return (
                  headerLower.includes("name") ||
                  headerLower.includes("Ø§Ø³Ù…") ||
                  headerLower.includes("phone") ||
                  headerLower.includes("Ù‡Ø§ØªÙ") ||
                  headerLower.includes("Ø±Ù‚Ù…") ||
                  headerLower.includes("service") ||
                  headerLower.includes("Ø®Ø¯Ù…Ø©")
                );
              });

              if (firstRowIsHeader) {
                headers.forEach((header, index) => {
                  const h = String(header).toLowerCase();
                  if (h.includes("name") || h.includes("Ø§Ø³Ù…")) {
                    nameIndex = index;
                  }
                  if (h.includes("phone") || h.includes("Ù‡Ø§ØªÙ") || h.includes("Ø±Ù‚Ù…") || h.includes("number")) {
                    phoneIndex = index;
                  }
                  if (h.includes("service") || h.includes("Ø®Ø¯Ù…Ø©")) {
                    serviceIndex = index;
                  }
                });
              }

              if (nameIndex === -1) nameIndex = 0;
              if (phoneIndex === -1) phoneIndex = 1;
              if (serviceIndex === -1) serviceIndex = 2;

              const startRow = firstRowIsHeader ? 1 : 0;

              for (let i = startRow; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                const name = row[nameIndex] ? String(row[nameIndex]).trim() : "";
                const phone = row[phoneIndex] ? String(row[phoneIndex]).trim() : "";
                const service = row[serviceIndex] ? String(row[serviceIndex]).trim() : "";

                if (name && phone) {
                  contacts.push({ name, phone, service });
                }
              }

              resolve(contacts);
            } catch (error) {
              reject(error);
            }
          };

          reader.onerror = function (error) {
            reject(error);
          };

          reader.readAsArrayBuffer(file);
        });
      }

      // Import contacts to database (UPDATED)
      async function importContacts(contactsToImport) {
        const result = {
          total: contactsToImport.length,
          success: 0,
          failed: 0,
          duplicates: 0,
          fixed: 0,
        };

        await loadContacts();

        const newContacts = [];

        for (const contact of contactsToImport) {
          const fixResult = fixPhoneCountryCode(contact.phone);
          const fixedPhone = fixResult.phone;

          if (fixResult.fixed) {
            result.fixed++;
          }

          if (existingPhones.has(fixedPhone)) {
            result.duplicates++;
            continue;
          }

          const contactData = {
            name: contact.name,
            phone: fixedPhone,
          };
          
          if (contact.service) {
            contactData.service = contact.service;
          }

          newContacts.push(contactData);
          existingPhones.add(fixedPhone);
        }

        if (newContacts.length === 0) {
          return result;
        }

        const chunkSize = 50;
        for (let i = 0; i < newContacts.length; i += chunkSize) {
          const chunk = newContacts.slice(i, i + chunkSize);
          const { error } = await supabaseClient
            .from("contact_list")
            .insert(chunk);

          if (error) {
            console.error("Error inserting chunk:", error);
            result.failed += chunk.length;
          } else {
            result.success += chunk.length;
          }
        }

        return result;
      }

      // ========== DRAG AND DROP ==========
      const importSection = document.getElementById("importSection");

      importSection.addEventListener("dragover", (e) => {
        e.preventDefault();
        importSection.classList.add("dragover");
      });

      importSection.addEventListener("dragleave", (e) => {
        e.preventDefault();
        importSection.classList.remove("dragover");
      });

      importSection.addEventListener("drop", (e) => {
        e.preventDefault();
        importSection.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          const validExtensions = [".xlsx", ".xls", ".csv"];
          const fileExtension = "." + file.name.split(".").pop().toLowerCase();

          if (validExtensions.includes(fileExtension)) {
            processExcelFile(file);
          } else {
            showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel ØµØ§Ù„Ø­ (.xlsx, .xls, .csv)", "error");
          }
        }
      });

      // ========== NEW: GROUPS FUNCTIONALITY ==========
      
      // Load groups from localStorage
      function loadGroups() {
        const savedGroups = localStorage.getItem("contact_groups");
        groups = savedGroups ? JSON.parse(savedGroups) : [];
        renderGroups();
      }

      // Save groups to localStorage
      function saveGroupsToStorage() {
        localStorage.setItem("contact_groups", JSON.stringify(groups));
      }

      // Render groups
      function renderGroups() {
        const groupsList = document.getElementById("groupsList");
        
        // Keep the "All" button
        groupsList.innerHTML = `
          <div class="group-item ${currentGroup === null ? 'active' : ''}" onclick="selectGroup(null)">
            <i class="fa-solid fa-users"></i>
            <span>Ø§Ù„ÙƒÙ„</span>
            <span class="group-count" id="allContactsCount">${allContacts.length}</span>
          </div>
        `;

        groups.forEach((group, index) => {
          const count = getGroupContactCount(group);
          groupsList.innerHTML += `
            <div class="group-item ${currentGroup === index ? 'active' : ''}" onclick="selectGroup(${index})">
              <i class="fa-solid fa-filter"></i>
              <span>${group.name}</span>
              <span class="group-count">${count}</span>
              <i class="fa-solid fa-trash delete-group" onclick="event.stopPropagation(); deleteGroup(${index})"></i>
            </div>
          `;
        });
      }

      // Get contact count for a group
      function getGroupContactCount(group) {
        let filtered = allContacts;

        if (group.service) {
          filtered = filtered.filter(c => c.service === group.service);
        }

        if (group.dateFrom) {
          filtered = filtered.filter(c => new Date(c.created_at) >= new Date(group.dateFrom));
        }

        if (group.dateTo) {
          filtered = filtered.filter(c => new Date(c.created_at) <= new Date(group.dateTo));
        }

        return filtered.length;
      }

      // Select a group
      function selectGroup(index) {
        currentGroup = index;
        applyCurrentGroupFilter();
        renderGroups();
      }

      // Apply current group filter
      function applyCurrentGroupFilter() {
        if (currentGroup === null) {
          contacts = [...allContacts];
        } else {
          const group = groups[currentGroup];
          contacts = [...allContacts];

          if (group.service) {
            contacts = contacts.filter(c => c.service === group.service);
          }

          if (group.dateFrom) {
            contacts = contacts.filter(c => new Date(c.created_at) >= new Date(group.dateFrom));
          }

          if (group.dateTo) {
            contacts = contacts.filter(c => new Date(c.created_at) <= new Date(group.dateTo));
          }
        }

        renderContacts();
        updateContactCountBadge();
      }

      // Delete a group
      function deleteGroup(index) {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ")) {
          groups.splice(index, 1);
          saveGroupsToStorage();
          
          if (currentGroup === index) {
            currentGroup = null;
            applyCurrentGroupFilter();
          }
          
          renderGroups();
          showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­");
        }
      }

      // Open group modal
      function openGroupModal() {
        document.getElementById("groupModal").classList.add("show");
        document.getElementById("groupName").value = "";
        document.getElementById("groupServiceFilter").value = "";
        document.getElementById("groupDateFrom").value = "";
        document.getElementById("groupDateTo").value = "";
      }

      // Close group modal
      function closeGroupModal() {
        document.getElementById("groupModal").classList.remove("show");
      }

      // Save group
      function saveGroup() {
        const name = document.getElementById("groupName").value.trim();
        const service = document.getElementById("groupServiceFilter").value;
        const dateFrom = document.getElementById("groupDateFrom").value;
        const dateTo = document.getElementById("groupDateTo").value;

        if (!name) {
          showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©", "error");
          return;
        }

        const newGroup = { name };
        if (service) newGroup.service = service;
        if (dateFrom) newGroup.dateFrom = dateFrom;
        if (dateTo) newGroup.dateTo = dateTo;

        groups.push(newGroup);
        saveGroupsToStorage();
        renderGroups();
        closeGroupModal();
        showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­!");
      }

      // Apply filters from dropdown
      function applyFilters() {
        const serviceFilter = document.getElementById("serviceFilter").value;
        
        contacts = [...allContacts];

        if (serviceFilter) {
          contacts = contacts.filter(c => c.service === serviceFilter);
        }

        renderContacts();
        updateContactCountBadge();
      }

      // Clear all filters
      function clearFilters() {
        document.getElementById("serviceFilter").value = "";
        currentGroup = null;
        contacts = [...allContacts];
        renderContacts();
        renderGroups();
        updateContactCountBadge();
      }

      // âœ… Theme toggle
      const themeToggle = document.getElementById("themeToggle");
      themeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const icon = themeToggle.querySelector("i");
        if (document.body.classList.contains("dark")) {
          icon.classList.replace("fa-moon", "fa-sun");
          localStorage.setItem("clinic_theme", "dark");
        } else {
          icon.classList.replace("fa-sun", "fa-moon");
          localStorage.setItem("clinic_theme", "light");
        }
      });

      if (localStorage.getItem("clinic_theme") === "dark") {
        document.body.classList.add("dark");
        themeToggle.querySelector("i").classList.replace("fa-moon", "fa-sun");
      }

      // âœ… Sidebar toggle
      const menuToggle = document.getElementById("menuToggle");
      const sidebar = document.getElementById("sidebar");
      menuToggle.addEventListener("click", () =>
        sidebar.classList.toggle("active")
      );

      // âœ… Add contact listener
      document.getElementById("addContactBtn").addEventListener("click", addContact);

      // Close modal when clicking outside
      document.getElementById("groupModal").addEventListener("click", function(e) {
        if (e.target === this) {
          closeGroupModal();
        }
      });

      // âœ… Initial load + auto refresh
      loadContacts();
      setInterval(loadContacts, 20000);