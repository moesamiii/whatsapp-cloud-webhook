<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ - Smile Clinic</title>
    <link rel="icon" type="image/png" href="./img/dummy-conan.jpeg" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="./dashboard.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS for Excel file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      @media (min-width: 1024px) {
        .dashboard-grid {
          width: 100%;
          display: flex;
          justify-content: center;
        }
        .table-card {
          width: 100% !important;
          max-width: none !important;
          margin: 0;
        }
      }

      input,
      button {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }

      body.dark input {
        background: #333;
        color: #fff;
        border-color: #555;
      }

      body.dark select {
        background: #333;
        color: #fff;
        border-color: #555;
      }

      .add-contact-form {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
      }

      .add-contact-form input {
        flex: 1 1 200px;
      }

      .add-contact-form select {
        flex: 1 1 180px;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }

      .add-contact-form button {
        background: #7c3aed;
        color: white;
        border: none;
        cursor: pointer;
        padding: 8px 16px;
      }

      .success-msg {
        color: green;
        margin-top: 10px;
        display: none;
      }

      .error-msg {
        color: red;
        margin-top: 10px;
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
      }

      th {
        background: #f4f4f4;
      }

      body.dark th {
        background: #222;
      }

      /* ========== NEW FEATURE: GROUPS SECTION STYLES ========== */
      .groups-section {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }

      body.dark .groups-section {
        background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
        border-color: #fbbf24;
      }

      .groups-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .groups-title {
        font-size: 18px;
        font-weight: 600;
        color: #92400e;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      body.dark .groups-title {
        color: #fcd34d;
      }

      .create-group-btn {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
      }

      .create-group-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
      }

      .groups-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .group-tag {
        background: white;
        border: 2px solid #fbbf24;
        border-radius: 25px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      body.dark .group-tag {
        background: #451a03;
        border-color: #fbbf24;
        color: #fef3c7;
      }

      .group-tag:hover {
        background: #fef3c7;
        transform: scale(1.02);
      }

      body.dark .group-tag:hover {
        background: #78350f;
      }

      .group-tag.active {
        background: #f59e0b;
        color: white;
        border-color: #d97706;
      }

      .group-tag .group-count {
        background: rgba(0, 0, 0, 0.15);
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
      }

      .group-tag .delete-group {
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 10px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin: 0;
      }

      .group-tag:hover .delete-group {
        display: flex;
      }

      /* Modal styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-overlay.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      body.dark .modal-content {
        background: #1f2937;
        color: #f3f4f6;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
      }

      body.dark .modal-header {
        border-color: #374151;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 20px;
        color: #f59e0b;
      }

      .modal-close {
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-body {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .modal-body label {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 5px;
        display: block;
      }

      .modal-body input,
      .modal-body select {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 14px;
        box-sizing: border-box;
      }

      body.dark .modal-body input,
      body.dark .modal-body select {
        background: #374151;
        border-color: #4b5563;
        color: #f3f4f6;
      }

      .filter-options {
        background: #f9fafb;
        border-radius: 10px;
        padding: 15px;
      }

      body.dark .filter-options {
        background: #374151;
      }

      .filter-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
      }

      .filter-row:last-child {
        margin-bottom: 0;
      }

      .filter-row label {
        min-width: 80px;
        margin-bottom: 0;
      }

      .filter-row select {
        flex: 1;
      }

      .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 2px solid #e5e7eb;
      }

      body.dark .modal-footer {
        border-color: #374151;
      }

      .modal-btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .modal-btn.primary {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
      }

      .modal-btn.primary:hover {
        transform: translateY(-2px);
      }

      .modal-btn.secondary {
        background: #e5e7eb;
        color: #374151;
        border: none;
      }

      body.dark .modal-btn.secondary {
        background: #4b5563;
        color: #f3f4f6;
      }

      /* Service badge */
      .service-badge {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        display: inline-block;
      }

      .service-badge.empty {
        background: #9ca3af;
      }

      /* ========== END NEW FEATURE: GROUPS SECTION ========== */

      /* ========== EXPORT SECTION STYLES ========== */
      .export-section {
        background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
        border: 2px solid #d946ef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 15px;
      }

      body.dark .export-section {
        background: linear-gradient(135deg, #4a1d6a 0%, #581c87 100%);
        border-color: #e879f9;
      }

      .export-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .export-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #d946ef 0%, #a855f7 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
      }

      .export-text h4 {
        margin: 0 0 4px 0;
        font-size: 16px;
        color: #7e22ce;
      }

      body.dark .export-text h4 {
        color: #e879f9;
      }

      .export-text p {
        margin: 0;
        font-size: 13px;
        color: #6b7280;
      }

      body.dark .export-text p {
        color: #d1d5db;
      }

      .export-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 28px;
        background: linear-gradient(135deg, #d946ef 0%, #a855f7 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(217, 70, 239, 0.3);
      }

      .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(217, 70, 239, 0.4);
        background: linear-gradient(135deg, #e879f9 0%, #c084fc 100%);
      }

      .export-btn:active {
        transform: translateY(0);
      }

      .export-btn i {
        font-size: 18px;
      }

      .contact-count-badge {
        background: rgba(217, 70, 239, 0.15);
        color: #a855f7;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
      }

      body.dark .contact-count-badge {
        background: rgba(217, 70, 239, 0.3);
        color: #e879f9;
      }

      /* ========== IMPORT SECTION STYLES ========== */
      .import-section {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px dashed #7c3aed;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
        transition: all 0.3s ease;
      }

      body.dark .import-section {
        background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
        border-color: #a78bfa;
      }

      .import-section:hover {
        border-color: #5b21b6;
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      }

      body.dark .import-section:hover {
        background: linear-gradient(135deg, #312e81 0%, #4c1d95 100%);
        border-color: #c4b5fd;
      }

      .import-section.dragover {
        border-color: #22c55e;
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        transform: scale(1.02);
      }

      body.dark .import-section.dragover {
        background: linear-gradient(135deg, #14532d 0%, #166534 100%);
      }

      .import-title {
        font-size: 18px;
        font-weight: 600;
        color: #5b21b6;
        margin-bottom: 10px;
      }

      body.dark .import-title {
        color: #c4b5fd;
      }

      .import-description {
        color: #6b7280;
        margin-bottom: 15px;
        font-size: 14px;
      }

      body.dark .import-description {
        color: #9ca3af;
      }

      .import-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .import-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
      }

      .import-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      }

      .import-btn:active {
        transform: translateY(0);
      }

      .import-btn.loading {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .import-btn.loading i {
        animation: spin 1s linear infinite;
      }

      .download-template-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      }

      .download-template-btn:hover {
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .file-input {
        display: none;
      }

      .import-stats {
        margin-top: 15px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        display: none;
      }

      body.dark .import-stats {
        background: rgba(0, 0, 0, 0.3);
      }

      .import-stats.show {
        display: block;
      }

      .import-stats p {
        margin: 5px 0;
        font-size: 14px;
      }

      .import-stats .success {
        color: #16a34a;
      }

      .import-stats .error {
        color: #dc2626;
      }

      .import-stats .info {
        color: #2563eb;
      }

      .import-stats .fixed {
        color: #f59e0b;
      }

      body.dark .import-stats .success {
        color: #4ade80;
      }

      body.dark .import-stats .error {
        color: #f87171;
      }

      body.dark .import-stats .info {
        color: #60a5fa;
      }

      body.dark .import-stats .fixed {
        color: #fbbf24;
      }

      /* Toast notification */
      .toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: #22c55e;
        color: white;
        padding: 16px 32px;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 9999;
      }

      .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      .toast.error {
        background: #ef4444;
      }

      .toast.warning {
        background: #f59e0b;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <div class="logo">
          <span>CONAN DASHBOARD</span>
        </div>
        <nav class="menu">
          <a href="dashboard.html">
            <i class="fa-solid fa-gauge"></i>
            Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
          </a>
          <a href="notifications.html" id="notificationLink">
            <i class="fa-solid fa-bell"></i>
            Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
          </a>
          <a href="analytics.html">
            <i class="fa-solid fa-rocket"></i>
            ØªØ­Ù„ÙŠÙ„Ø§Øª
          </a>
          <a href="booking.html">
            <i class="fa-solid fa-table"></i>
            Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØ§ØµÙ„
          </a>
          <!-- âœ… NEW MENU ITEM ADDED HERE -->
          <a href="contactlist.html" class="active">
            <i class="fa-solid fa-address-book"></i>
            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØ§ØµÙ„
          </a>
          <!-- âœ… END NEW ITEM -->
          <a href="AIsettings.html">
            <i class="fa-solid fa-robot"></i>
            Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
          </a>
          <a href="offers.html">
            <i class="fa-solid fa-gift"></i>
            Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø§Ø¹Ù„Ø§Ù†ÙŠØ©
          </a>
        </nav>
      </aside>

      <!-- MAIN -->
      <main class="main-content" id="dashboardContent">
        <header class="header">
          <div class="header-left">
            <button class="menu-toggle icon-btn" id="menuToggle">
              <i class="fa-solid fa-bars"></i>
            </button>
            <h1>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</h1>
          </div>
          <div class="header-right">
            <button class="icon-btn" id="themeToggle">
              <i class="fa-regular fa-moon"></i>
            </button>
          </div>
        </header>

        <section class="dashboard-grid">
          <div class="table-card">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</h3>

            <!-- âœ… NEW FEATURE: CONTACT GROUPS SECTION -->
            <div class="groups-section">
              <div class="groups-header">
                <div class="groups-title">
                  <i class="fa-solid fa-layer-group"></i>
                  Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
                </div>
                <button
                  class="create-group-btn"
                  onclick="openCreateGroupModal()"
                >
                  <i class="fa-solid fa-plus"></i>
                  Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </button>
              </div>
              <div class="groups-list" id="groupsList">
                <!-- Groups will be rendered here dynamically -->
              </div>
            </div>
            <!-- âœ… END CONTACT GROUPS SECTION -->

            <!-- âœ… EXPORT TO EXCEL SECTION -->
            <div class="export-section">
              <div class="export-info">
                <div class="export-icon">
                  <i class="fa-solid fa-file-excel"></i>
                </div>
                <div class="export-text">
                  <h4>ØªØµØ¯ÙŠØ± Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h4>
                  <p>Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ…Ù„Ù Excel (Ù…Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø©)</p>
                </div>
                <span class="contact-count-badge" id="contactCountBadge"
                  >0 Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„</span
                >
              </div>
              <button class="export-btn" onclick="exportToExcel()">
                <i class="fa-solid fa-download"></i>
                ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
              </button>
            </div>
            <!-- âœ… END EXPORT SECTION -->

            <!-- âœ… IMPORT FROM EXCEL SECTION - UPDATED with service -->
            <div class="import-section" id="importSection">
              <div class="import-title">
                <i class="fa-solid fa-file-excel"></i>
                Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Excel
              </div>
              <div class="import-description">
                Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Excel Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯<br />
                <small
                  >ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰: Ø§Ù„Ø§Ø³Ù… (name)ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (phone)ØŒ
                  <strong style="color: #3b82f6"
                    >ÙˆØ§Ù„Ø®Ø¯Ù…Ø© (service) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ</strong
                  ></small
                ><br />
                <small style="color: #f59e0b"
                  >âœ¨ ÙŠØªÙ… ØªØµØ­ÙŠØ­ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ù†Ù‡Ø§ÙŠØ©
                  Ø§Ù„Ø±Ù‚Ù…</small
                >
              </div>
              <div class="import-buttons">
                <button
                  class="import-btn"
                  id="importBtn"
                  onclick="document.getElementById('excelFileInput').click()"
                >
                  <i class="fa-solid fa-file-import"></i>
                  Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel
                </button>
                <button
                  class="import-btn download-template-btn"
                  id="downloadTemplateBtn"
                  onclick="downloadTemplate()"
                >
                  <i class="fa-solid fa-download"></i>
                  ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Excel
                </button>
              </div>
              <input
                type="file"
                id="excelFileInput"
                class="file-input"
                accept=".xlsx,.xls,.csv"
                onchange="handleFileSelect(event)"
              />
              <div class="import-stats" id="importStats">
                <p class="info" id="totalRows">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ: 0</p>
                <p class="success" id="successRows">ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­: 0</p>
                <p class="fixed" id="fixedRows">ØªÙ… ØªØµØ­ÙŠØ­ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©: 0</p>
                <p class="info" id="serviceRows">Ù…Ø¹ Ø®Ø¯Ù…Ø©: 0</p>
                <p class="error" id="errorRows">ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: 0</p>
                <p class="info" id="duplicateRows">Ù…ÙƒØ±Ø±Ø© (ØªÙ… ØªØ®Ø·ÙŠÙ‡Ø§): 0</p>
              </div>
            </div>
            <!-- âœ… END IMPORT SECTION -->

            <!-- âœ… Add new contact form - UPDATED with service dropdown -->
            <div class="add-contact-form">
              <input type="text" id="contactName" placeholder="Ø§Ù„Ø§Ø³Ù…" />
              <input type="text" id="contactPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
              <select id="contactService">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
                <option value="ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ù†Ø§Ù†">ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="ØªØ¨ÙŠÙŠØ¶ Ø§Ù„Ø£Ø³Ù†Ø§Ù†">ØªØ¨ÙŠÙŠØ¶ Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="Ø­Ø´Ùˆ Ø§Ù„Ø£Ø³Ù†Ø§Ù†">Ø­Ø´Ùˆ Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø¬Ø°ÙˆØ±">Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø¬Ø°ÙˆØ±</option>
                <option value="ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø£Ø³Ù†Ø§Ù†">ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="Ø®Ù„Ø¹ Ø§Ù„Ø£Ø³Ù†Ø§Ù†">Ø®Ù„Ø¹ Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="Ø²Ø±Ø§Ø¹Ø© Ø§Ù„Ø£Ø³Ù†Ø§Ù†">Ø²Ø±Ø§Ø¹Ø© Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="Ø§Ø¨ØªØ³Ø§Ù…Ø© Ù‡ÙˆÙ„ÙŠÙˆØ¯">Ø§Ø¨ØªØ³Ø§Ù…Ø© Ù‡ÙˆÙ„ÙŠÙˆØ¯</option>
                <option value="ÙØ­Øµ Ø¹Ø§Ù…">ÙØ­Øµ Ø¹Ø§Ù…</option>
                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
              </select>
              <button id="addContactBtn">
                <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„
              </button>
            </div>
            <p class="success-msg" id="successMsg">
              âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­
            </p>
            <p class="error-msg" id="errorMsg">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©</p>

            <!-- UPDATED TABLE with service column -->
            <table id="contactTable">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                  <th>Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <footer>Â© 2025 Smile Clinic</footer>
      </main>
    </div>

    <!-- âœ… NEW FEATURE: CREATE GROUP MODAL -->
    <div class="modal-overlay" id="createGroupModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fa-solid fa-layer-group"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
          <button class="modal-close" onclick="closeCreateGroupModal()">
            Ã—
          </button>
        </div>
        <div class="modal-body">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
            <input
              type="text"
              id="groupName"
              placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù…Ù„Ø§Ø¡ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ù†Ø§Ù†"
            />
          </div>

          <div class="filter-options">
            <label style="margin-bottom: 10px; display: block"
              >ÙÙ„ØªØ±Ø© Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø©</label
            >

            <div class="filter-row">
              <label>Ø§Ù„Ø®Ø¯Ù…Ø©:</label>
              <select id="groupServiceFilter">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</option>
                <option value="ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ù†Ø§Ù†">ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="ØªØ¨ÙŠÙŠØ¶ Ø§Ù„Ø£Ø³Ù†Ø§Ù†">ØªØ¨ÙŠÙŠØ¶ Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="Ø­Ø´Ùˆ Ø§Ù„Ø£Ø³Ù†Ø§Ù†">Ø­Ø´Ùˆ Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø¬Ø°ÙˆØ±">Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø¬Ø°ÙˆØ±</option>
                <option value="ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø£Ø³Ù†Ø§Ù†">ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="Ø®Ù„Ø¹ Ø§Ù„Ø£Ø³Ù†Ø§Ù†">Ø®Ù„Ø¹ Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="Ø²Ø±Ø§Ø¹Ø© Ø§Ù„Ø£Ø³Ù†Ø§Ù†">Ø²Ø±Ø§Ø¹Ø© Ø§Ù„Ø£Ø³Ù†Ø§Ù†</option>
                <option value="Ø§Ø¨ØªØ³Ø§Ù…Ø© Ù‡ÙˆÙ„ÙŠÙˆØ¯">Ø§Ø¨ØªØ³Ø§Ù…Ø© Ù‡ÙˆÙ„ÙŠÙˆØ¯</option>
                <option value="ÙØ­Øµ Ø¹Ø§Ù…">ÙØ­Øµ Ø¹Ø§Ù…</option>
                <option value="no_service">Ø¨Ø¯ÙˆÙ† Ø®Ø¯Ù…Ø©</option>
              </select>
            </div>
          </div>

          <div>
            <label>Ù„ÙˆÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
            <select id="groupColor">
              <option value="#f59e0b">ğŸŸ¡ Ø£ØµÙØ±</option>
              <option value="#3b82f6">ğŸ”µ Ø£Ø²Ø±Ù‚</option>
              <option value="#22c55e">ğŸŸ¢ Ø£Ø®Ø¶Ø±</option>
              <option value="#ef4444">ğŸ”´ Ø£Ø­Ù…Ø±</option>
              <option value="#8b5cf6">ğŸŸ£ Ø¨Ù†ÙØ³Ø¬ÙŠ</option>
              <option value="#ec4899">ğŸ’— ÙˆØ±Ø¯ÙŠ</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn secondary" onclick="closeCreateGroupModal()">
            Ø¥Ù„ØºØ§Ø¡
          </button>
          <button class="modal-btn primary" onclick="createGroup()">
            <i class="fa-solid fa-check"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
          </button>
        </div>
      </div>
    </div>
    <!-- âœ… END CREATE GROUP MODAL -->

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
      // âœ… FIXED: Supabase setup using supabaseClient to match dashboard.html
      const SUPABASE_URL = "https://ylsbmxedhycjqaorjkvm.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlsc2JteGVkaHljanFhb3Jqa3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTk5NTUsImV4cCI6MjA3NjM5NTk1NX0.W61xOww2neu6RA4yCJUob66p4OfYcgLSVw3m3yttz1E";
      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY
      );

      let contacts = [];
      let existingPhones = new Set();

      // âœ… NEW: Variables for groups feature
      let contactGroups = [];
      let currentGroup = "all";

      // ========== âœ¨ NEW: PHONE NUMBER COUNTRY CODE FIX FUNCTION ========== //
      /**
       * Fix phone numbers that have country code at the end instead of the beginning
       * Example: "5012345966" -> "+966501234"
       * Example: "7812345962" -> "+962781234"
       *
       * Supported country codes:
       * - 966 (Saudi Arabia)
       * - 962 (Jordan)
       * - 971 (UAE)
       * - 973 (Bahrain)
       * - 974 (Qatar)
       * - 968 (Oman)
       * - 965 (Kuwait)
       * - 20 (Egypt)
       * - 961 (Lebanon)
       * - 963 (Syria)
       * - 964 (Iraq)
       * - 212 (Morocco)
       * - 216 (Tunisia)
       * - 213 (Algeria)
       */
      function fixPhoneCountryCode(phone) {
        // Remove all non-digit characters first
        let cleaned = String(phone).replace(/\D/g, "");

        // If already starts with +, return as is
        if (String(phone).trim().startsWith("+")) {
          return { phone: String(phone).trim(), fixed: false };
        }

        // List of country codes to check (ordered by length, longest first)
        const countryCodes = [
          "966", // Saudi Arabia
          "962", // Jordan
          "971", // UAE
          "973", // Bahrain
          "974", // Qatar
          "968", // Oman
          "965", // Kuwait
          "961", // Lebanon
          "963", // Syria
          "964", // Iraq
          "212", // Morocco
          "216", // Tunisia
          "213", // Algeria
          "20", // Egypt (2 digits)
        ];

        // Check if country code is at the END of the number
        for (const code of countryCodes) {
          if (cleaned.endsWith(code)) {
            // Get the local number part (without country code)
            const localNumber = cleaned.slice(0, -code.length);

            // Validate: local number should be reasonable length (7-10 digits)
            if (localNumber.length >= 7 && localNumber.length <= 10) {
              // Move country code to the beginning with + sign
              const fixedPhone = "+" + code + localNumber;
              console.log(`ğŸ“± Fixed phone: ${phone} -> ${fixedPhone}`);
              return { phone: fixedPhone, fixed: true };
            }
          }
        }

        // Check if already starts with country code (correct format)
        for (const code of countryCodes) {
          if (cleaned.startsWith(code)) {
            // Already correct, just add + if missing
            return { phone: "+" + cleaned, fixed: false };
          }
        }

        // No country code found, return original
        return { phone: cleaned, fixed: false };
      }

      // Show toast notification
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "toast show";
        if (type === "error") toast.classList.add("error");
        if (type === "warning") toast.classList.add("warning");
        setTimeout(() => {
          toast.className = "toast";
        }, 3000);
      }

      // Update contact count badge
      function updateContactCountBadge() {
        const badge = document.getElementById("contactCountBadge");
        badge.textContent = `${contacts.length} Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„`;
      }

      // ========== âœ… NEW FEATURE: GROUPS MANAGEMENT ========== //

      // Load groups from localStorage
      function loadGroups() {
        const savedGroups = localStorage.getItem("contactGroups");
        contactGroups = savedGroups ? JSON.parse(savedGroups) : [];
        renderGroups();
      }

      // Save groups to localStorage
      function saveGroups() {
        localStorage.setItem("contactGroups", JSON.stringify(contactGroups));
      }

      // Get contact count for a specific group based on service filter
      function getGroupContactCount(group) {
        return contacts.filter((c) => {
          if (group.serviceFilter === "all") return true;
          if (group.serviceFilter === "no_service") {
            return !c.service || c.service === "";
          }
          return c.service === group.serviceFilter;
        }).length;
      }

      // Render groups in the UI
      function renderGroups() {
        const groupsList = document.getElementById("groupsList");

        // Start with "All" group
        let html = `
          <div class="group-tag ${
            currentGroup === "all" ? "active" : ""
          }" onclick="selectGroup('all')">
            <i class="fa-solid fa-users"></i>
            Ø§Ù„ÙƒÙ„
            <span class="group-count">${contacts.length}</span>
          </div>
        `;

        // Add custom groups
        contactGroups.forEach((group, index) => {
          const count = getGroupContactCount(group);
          html += `
            <div class="group-tag ${currentGroup === group.id ? "active" : ""}" 
                 style="border-color: ${group.color};" 
                 onclick="selectGroup('${group.id}')">
              <i class="fa-solid fa-tag" style="color: ${group.color};"></i>
              ${group.name}
              <span class="group-count">${count}</span>
              <button class="delete-group" onclick="event.stopPropagation(); deleteGroup(${index})">Ã—</button>
            </div>
          `;
        });

        groupsList.innerHTML = html;
      }

      // Select a group and filter contacts
      function selectGroup(groupId) {
        currentGroup = groupId;
        renderGroups();
        renderContacts();
      }

      // Open create group modal
      function openCreateGroupModal() {
        document.getElementById("createGroupModal").classList.add("show");
      }

      // Close create group modal
      function closeCreateGroupModal() {
        document.getElementById("createGroupModal").classList.remove("show");
        // Reset form
        document.getElementById("groupName").value = "";
        document.getElementById("groupServiceFilter").value = "all";
        document.getElementById("groupColor").value = "#f59e0b";
      }

      // Create a new group
      function createGroup() {
        const name = document.getElementById("groupName").value.trim();
        const serviceFilter =
          document.getElementById("groupServiceFilter").value;
        const color = document.getElementById("groupColor").value;

        if (!name) {
          showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©", "error");
          return;
        }

        const newGroup = {
          id: "group_" + Date.now(),
          name: name,
          serviceFilter: serviceFilter,
          color: color,
          createdAt: new Date().toISOString(),
        };

        contactGroups.push(newGroup);
        saveGroups();
        renderGroups();
        closeCreateGroupModal();

        showToast(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© "${name}" Ø¨Ù†Ø¬Ø§Ø­!`);
      }

      // Delete a group
      function deleteGroup(index) {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ")) {
          const groupName = contactGroups[index].name;
          const groupId = contactGroups[index].id;
          contactGroups.splice(index, 1);
          saveGroups();

          // If we deleted the currently selected group, go back to "all"
          if (currentGroup === groupId) {
            currentGroup = "all";
          }

          renderGroups();
          renderContacts();
          showToast(`ØªÙ… Ø­Ø°Ù Ù…Ø¬Ù…ÙˆØ¹Ø© "${groupName}"`);
        }
      }

      // ========== END GROUPS MANAGEMENT ========== //

      // âœ… Load contacts (from bookings + contact_list) - UPDATED to include service
      async function loadContacts() {
        const { data: bookingData, error: bookingError } = await supabaseClient
          .from("bookings")
          .select("name, phone, service");

        const { data: contactData, error: contactError } = await supabaseClient
          .from("contact_list")
          .select("*")
          .order("created_at", { ascending: false });

        if (bookingError || contactError) {
          console.error("Error loading data:", bookingError || contactError);
          return;
        }

        // Merge bookings + saved contacts, filter duplicates
        const combined = [...(bookingData || []), ...(contactData || [])];
        const unique = [];
        existingPhones = new Set();

        combined.forEach((c) => {
          if (!c.phone || existingPhones.has(c.phone)) return;
          existingPhones.add(c.phone);
          unique.push({
            name: c.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…",
            phone: c.phone,
            service: c.service || "",
            created_at: c.created_at || new Date().toISOString(),
          });
        });

        contacts = unique;
        renderContacts();
        updateContactCountBadge();
        renderGroups(); // Update groups count
      }

      // âœ… Add new contact - UPDATED to include service
      async function addContact() {
        const name = document.getElementById("contactName").value.trim();
        let phone = document.getElementById("contactPhone").value.trim();
        const service = document.getElementById("contactService").value;
        const successMsg = document.getElementById("successMsg");
        const errorMsg = document.getElementById("errorMsg");

        successMsg.style.display = "none";
        errorMsg.style.display = "none";

        if (!name || !phone) {
          errorMsg.textContent = "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ";
          errorMsg.style.display = "block";
          return;
        }

        // âœ¨ Fix country code if needed
        const fixResult = fixPhoneCountryCode(phone);
        phone = fixResult.phone;

        const { error } = await supabaseClient
          .from("contact_list")
          .insert([{ name, phone, service }]);

        if (error) {
          console.error("Error inserting contact:", error);
          errorMsg.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©";
          errorMsg.style.display = "block";
        } else {
          if (fixResult.fixed) {
            successMsg.textContent =
              "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ (ØªÙ… ØªØµØ­ÙŠØ­ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©)";
          } else {
            successMsg.textContent = "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­";
          }
          successMsg.style.display = "block";
          document.getElementById("contactName").value = "";
          document.getElementById("contactPhone").value = "";
          document.getElementById("contactService").value = "";
          loadContacts();
          setTimeout(() => (successMsg.style.display = "none"), 2000);
        }
      }

      // âœ… Render table - UPDATED with service column and group filtering
      function renderContacts() {
        const tbody = document.querySelector("#contactTable tbody");
        tbody.innerHTML = "";

        // Filter contacts based on current group
        let filteredContacts = contacts;

        if (currentGroup !== "all") {
          const group = contactGroups.find((g) => g.id === currentGroup);
          if (group) {
            filteredContacts = contacts.filter((c) => {
              if (group.serviceFilter === "all") return true;
              if (group.serviceFilter === "no_service") {
                return !c.service || c.service === "";
              }
              return c.service === group.serviceFilter;
            });
          }
        }

        if (!filteredContacts.length) {
          tbody.innerHTML = "<tr><td colspan='4'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
          return;
        }

        filteredContacts.forEach((c) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${c.name}</td>
            <td dir="ltr" style="text-align: center;">${c.phone}</td>
            <td>${
              c.service
                ? `<span class="service-badge">${c.service}</span>`
                : `<span class="service-badge empty">-</span>`
            }</td>
            <td>${new Date(c.created_at).toLocaleString("ar-EG")}</td>
          `;
          tbody.appendChild(row);
        });
      }

      // ========== EXPORT TO EXCEL FUNCTION - UPDATED with service column ==========
      function exportToExcel() {
        if (contacts.length === 0) {
          showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ù„Ù„ØªØµØ¯ÙŠØ±", "warning");
          return;
        }

        try {
          // Prepare data for export with service
          const exportData = contacts.map((contact, index) => ({
            "#": index + 1,
            Ø§Ù„Ø§Ø³Ù…: contact.name,
            "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ": contact.phone,
            Ø§Ù„Ø®Ø¯Ù…Ø©: contact.service || "",
            "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©": new Date(contact.created_at).toLocaleString(
              "ar-EG"
            ),
          }));

          // Create worksheet
          const worksheet = XLSX.utils.json_to_sheet(exportData);

          // Set column widths
          worksheet["!cols"] = [
            { wch: 5 }, // #
            { wch: 25 }, // Name
            { wch: 18 }, // Phone
            { wch: 20 }, // Service
            { wch: 22 }, // Date
          ];

          // Create workbook
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„");

          // Generate filename with current date
          const today = new Date();
          const dateStr = today.toISOString().split("T")[0];
          const filename = `contacts_export_${dateStr}.xlsx`;

          // Download file
          XLSX.writeFile(workbook, filename);

          showToast(`ØªÙ… ØªØµØ¯ÙŠØ± ${contacts.length} Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!`);
        } catch (error) {
          console.error("Error exporting to Excel:", error);
          showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±", "error");
        }
      }

      // ========== EXCEL IMPORT FUNCTIONS ==========

      // Download Excel template - UPDATED with service column
      function downloadTemplate() {
        const templateData = [
          {
            name: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ 1",
            phone: "+966501234567",
            service: "ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ù†Ø§Ù†",
          },
          {
            name: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ 2",
            phone: "+962791234567",
            service: "ØªØ¨ÙŠÙŠØ¶ Ø§Ù„Ø£Ø³Ù†Ø§Ù†",
          },
          { name: "Customer Name 3", phone: "+971501234567", service: "" },
        ];

        const worksheet = XLSX.utils.json_to_sheet(templateData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Contacts");

        // Set column widths
        worksheet["!cols"] = [{ wch: 25 }, { wch: 18 }, { wch: 20 }];

        XLSX.writeFile(workbook, "contacts_template.xlsx");
        showToast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Excel Ø¨Ù†Ø¬Ø§Ø­!");
      }

      // Handle file selection
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const validExtensions = [".xlsx", ".xls", ".csv"];
        const fileExtension = "." + file.name.split(".").pop().toLowerCase();

        if (!validExtensions.includes(fileExtension)) {
          showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel ØµØ§Ù„Ø­ (.xlsx, .xls, .csv)", "error");
          return;
        }

        processExcelFile(file);
      }

      // Process Excel file
      async function processExcelFile(file) {
        const importBtn = document.getElementById("importBtn");
        const importStats = document.getElementById("importStats");

        // Set loading state
        importBtn.classList.add("loading");
        importBtn.innerHTML =
          '<i class="fa-solid fa-spinner"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...';

        try {
          const data = await readExcelFile(file);

          if (!data || data.length === 0) {
            showToast("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©", "error");
            return;
          }

          // Import contacts
          const result = await importContacts(data);

          // Show stats
          document.getElementById(
            "totalRows"
          ).textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ: ${result.total}`;
          document.getElementById(
            "successRows"
          ).textContent = `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­: ${result.success}`;
          document.getElementById(
            "fixedRows"
          ).textContent = `ØªÙ… ØªØµØ­ÙŠØ­ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©: ${result.fixed}`;
          document.getElementById(
            "serviceRows"
          ).textContent = `Ù…Ø¹ Ø®Ø¯Ù…Ø©: ${result.withService}`;
          document.getElementById(
            "errorRows"
          ).textContent = `ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ${result.failed}`;
          document.getElementById(
            "duplicateRows"
          ).textContent = `Ù…ÙƒØ±Ø±Ø© (ØªÙ… ØªØ®Ø·ÙŠÙ‡Ø§): ${result.duplicates}`;
          importStats.classList.add("show");

          if (result.success > 0) {
            let message = `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${result.success} Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!`;
            if (result.fixed > 0) {
              message += ` (ØªÙ… ØªØµØ­ÙŠØ­ ${result.fixed} Ø±Ù‚Ù…)`;
            }
            if (result.withService > 0) {
              message += ` (${result.withService} Ù…Ø¹ Ø®Ø¯Ù…Ø©)`;
            }
            showToast(message);
            loadContacts();
          } else if (result.duplicates === result.total) {
            showToast("Ø¬Ù…ÙŠØ¹ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹", "warning");
          } else {
            showToast("Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„", "error");
          }
        } catch (error) {
          console.error("Error processing file:", error);
          showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù", "error");
        } finally {
          // Reset button state
          importBtn.classList.remove("loading");
          importBtn.innerHTML =
            '<i class="fa-solid fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel';
          // Reset file input
          document.getElementById("excelFileInput").value = "";
        }
      }

      // Read Excel file - UPDATED to include service column
      function readExcelFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });

              // Get first sheet
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];

              // Convert to JSON
              const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                header: 1,
              });

              // Parse rows (skip header if exists)
              const contacts = [];
              const headers = jsonData[0] || [];

              // Find name, phone, and service column indices
              let nameIndex = -1;
              let phoneIndex = -1;
              let serviceIndex = -1;

              // Check if first row is header
              const firstRowIsHeader = headers.some((h) => {
                const headerLower = String(h).toLowerCase();
                return (
                  headerLower.includes("name") ||
                  headerLower.includes("Ø§Ø³Ù…") ||
                  headerLower.includes("phone") ||
                  headerLower.includes("Ù‡Ø§ØªÙ") ||
                  headerLower.includes("Ø±Ù‚Ù…") ||
                  headerLower.includes("service") ||
                  headerLower.includes("Ø®Ø¯Ù…Ø©")
                );
              });

              if (firstRowIsHeader) {
                // Find column indices from header
                headers.forEach((header, index) => {
                  const h = String(header).toLowerCase();
                  if (h.includes("name") || h.includes("Ø§Ø³Ù…")) {
                    nameIndex = index;
                  }
                  if (
                    h.includes("phone") ||
                    h.includes("Ù‡Ø§ØªÙ") ||
                    h.includes("Ø±Ù‚Ù…") ||
                    h.includes("number")
                  ) {
                    phoneIndex = index;
                  }
                  if (h.includes("service") || h.includes("Ø®Ø¯Ù…Ø©")) {
                    serviceIndex = index;
                  }
                });
              }

              // Default to first two columns if headers not found
              if (nameIndex === -1) nameIndex = 0;
              if (phoneIndex === -1) phoneIndex = 1;
              // serviceIndex remains -1 if not found, meaning no service column

              // Start from row 1 if header exists, otherwise row 0
              const startRow = firstRowIsHeader ? 1 : 0;

              for (let i = startRow; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                const name = row[nameIndex]
                  ? String(row[nameIndex]).trim()
                  : "";
                const phone = row[phoneIndex]
                  ? String(row[phoneIndex]).trim()
                  : "";
                const service =
                  serviceIndex !== -1 && row[serviceIndex]
                    ? String(row[serviceIndex]).trim()
                    : "";

                if (name && phone) {
                  contacts.push({ name, phone, service });
                }
              }

              resolve(contacts);
            } catch (error) {
              reject(error);
            }
          };

          reader.onerror = function (error) {
            reject(error);
          };

          reader.readAsArrayBuffer(file);
        });
      }

      // Import contacts to database - UPDATED to include service
      async function importContacts(contactsToImport) {
        const result = {
          total: contactsToImport.length,
          success: 0,
          failed: 0,
          duplicates: 0,
          fixed: 0,
          withService: 0, // âœ… NEW: Track contacts with service
        };

        // Reload existing phones to get latest data
        await loadContacts();

        const newContacts = [];

        for (const contact of contactsToImport) {
          // âœ¨ NEW: Fix country code if it's at the end
          const fixResult = fixPhoneCountryCode(contact.phone);
          const fixedPhone = fixResult.phone;

          if (fixResult.fixed) {
            result.fixed++;
          }

          // âœ… Count contacts with service
          if (contact.service && contact.service.trim() !== "") {
            result.withService++;
          }

          // Check for duplicates (using fixed phone)
          if (existingPhones.has(fixedPhone)) {
            result.duplicates++;
            continue;
          }

          newContacts.push({
            name: contact.name,
            phone: fixedPhone,
            service: contact.service || "", // Include service
          });

          // Add to existing set to prevent duplicates within the same import
          existingPhones.add(fixedPhone);
        }

        if (newContacts.length === 0) {
          return result;
        }

        // Batch insert (in chunks of 50 to avoid issues)
        const chunkSize = 50;
        for (let i = 0; i < newContacts.length; i += chunkSize) {
          const chunk = newContacts.slice(i, i + chunkSize);
          const { error } = await supabaseClient
            .from("contact_list")
            .insert(chunk);

          if (error) {
            console.error("Error inserting chunk:", error);
            result.failed += chunk.length;
          } else {
            result.success += chunk.length;
          }
        }

        return result;
      }

      // ========== DRAG AND DROP ==========
      const importSection = document.getElementById("importSection");

      importSection.addEventListener("dragover", (e) => {
        e.preventDefault();
        importSection.classList.add("dragover");
      });

      importSection.addEventListener("dragleave", (e) => {
        e.preventDefault();
        importSection.classList.remove("dragover");
      });

      importSection.addEventListener("drop", (e) => {
        e.preventDefault();
        importSection.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          const validExtensions = [".xlsx", ".xls", ".csv"];
          const fileExtension = "." + file.name.split(".").pop().toLowerCase();

          if (validExtensions.includes(fileExtension)) {
            processExcelFile(file);
          } else {
            showToast(
              "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel ØµØ§Ù„Ø­ (.xlsx, .xls, .csv)",
              "error"
            );
          }
        }
      });

      // âœ… Theme toggle
      const themeToggle = document.getElementById("themeToggle");
      themeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const icon = themeToggle.querySelector("i");
        if (document.body.classList.contains("dark")) {
          icon.classList.replace("fa-moon", "fa-sun");
          localStorage.setItem("clinic_theme", "dark");
        } else {
          icon.classList.replace("fa-sun", "fa-moon");
          localStorage.setItem("clinic_theme", "light");
        }
      });

      if (localStorage.getItem("clinic_theme") === "dark") {
        document.body.classList.add("dark");
        themeToggle.querySelector("i").classList.replace("fa-moon", "fa-sun");
      }

      // âœ… Sidebar toggle
      const menuToggle = document.getElementById("menuToggle");
      const sidebar = document.getElementById("sidebar");
      menuToggle.addEventListener("click", () =>
        sidebar.classList.toggle("active")
      );

      // âœ… Add contact listener
      document
        .getElementById("addContactBtn")
        .addEventListener("click", addContact);

      // âœ… Initial load + auto refresh
      loadGroups(); // Load groups first
      loadContacts();
      setInterval(loadContacts, 20000);
    </script>
  </body>
</html>
